<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Orden de Compra</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            color: #333;
            max-width: 800px;
            margin: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .company-info h1 {
            margin: 0;
            color: #4F46E5;
        }

        .doc-info {
            text-align: right;
        }

        .doc-info h2 {
            margin: 0;
            color: #555;
        }

        .grid {
            display: flex;
            margin-bottom: 20px;
            gap: 40px;
        }

        .box {
            flex: 1;
        }

        .box h3 {
            border-bottom: 1px solid #ccc;
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border-bottom: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #f9f9f9;
            font-weight: bold;
        }

        .totals {
            margin-top: 20px;
            text-align: right;
        }

        .totals p {
            margin: 5px 0;
        }

        .grand-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4F46E5;
        }

        .footer {
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 10px;
            font-size: 0.8rem;
            color: #888;
            text-align: center;
        }

        @media print {
            body {
                padding: 0;
            }

            button {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div style="text-align: right; margin-bottom: 20px;">
        <button onclick="window.print()"
            style="padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer;">Imprimir
            PDF</button>
    </div>

    <div class="header">
        <div class="company-info">
            <h1 id="company-name">Mi Empresa</h1>
            <p id="company-nit">NIT: 800.000.000</p>
            <p id="company-dir">Calle Falsa 123</p>
        </div>
        <div class="doc-info">
            <h2>ORDEN DE COMPRA</h2>
            <h3 id="doc-number" style="color: #E63946; margin-top: 5px;">#OC-000</h3>
            <p style="margin: 5px 0;">Fecha: <span id="doc-date">01/01/2026</span></p>
        </div>
    </div>

    <div class="grid">
        <div class="box">
            <h3>PROVEEDOR</h3>
            <p id="prov-name" style="font-weight: bold;">Nombre Proveedor</p>
            <p id="prov-nit">NIT: 900.000.000</p>
            <p id="prov-address">Dirección Proveedor</p>
        </div>
        <div class="box">
            <h3>ENVIAR A</h3>
            <p id="branch-name">Bodega Principal</p>
            <p id="branch-address">Dirección Sucursal</p>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th style="width: 80px; text-align: center;">Cant</th>
                <th style="width: 120px; text-align: right;">Costo Est.</th>
                <th style="width: 120px; text-align: right;">Total</th>
            </tr>
        </thead>
        <tbody id="items-body">
            <!-- Items -->
        </tbody>
    </table>

    <div class="totals">
        <p>Subtotal: <span id="val-subtotal">$0.00</span></p>
        <p class="grand-total">Total: <span id="val-total">$0.00</span></p>
    </div>

    <div class="footer">
        <p>Esta orden de compra es un documento de solicitud interna y no constituye una factura fiscal.</p>
        <p>Generado por ERPod Software</p>
    </div>

    <script>
        // Data Loading Logic
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const token = localStorage.getItem('token');

        async function loadData() {
            if (!id) return alert('No ID provided');

            try {
                // Get Config for Company Info
                const cfgRes = await fetch('../../assets/config.json');
                const cfg = await cfgRes.json();
                const API = cfg.apiUrl;

                // Load Order
                const res = await fetch(`${API}/compras`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                const order = data.data.find(x => x.id == id); // Simple find for now, ideally fetch by ID endpoint

                if (!order) return document.body.innerHTML = '<h1>Orden no encontrada</h1>';

                // Fill UI
                document.getElementById('doc-number').textContent = order.combo_documento || `#${order.id}`;
                document.getElementById('doc-date').textContent = new Date(order.fecha).toLocaleDateString();

                document.getElementById('prov-name').textContent = order.proveedor_nombre;
                document.getElementById('prov-nit').textContent = order.proveedor_nit || 'NIT: N/A';

                // Fetch Details
                const detRes = await fetch(`${API}/compras/${id}/detalles`, { headers: { 'Authorization': `Bearer ${token}` } });
                const detData = await detRes.json();

                const table = document.getElementById('items-body');
                let subtotal = 0;

                detData.data.forEach(item => {
                    const row = document.createElement('tr');
                    const cost = parseFloat(item.costo_unitario);
                    const qty = item.cantidad;
                    const total = cost * qty;
                    subtotal += total;

                    row.innerHTML = `
                        <td>${item.nombre_producto}</td>
                        <td style="text-align: center;">${qty}</td>
                        <td style="text-align: right;">$${cost.toLocaleString()}</td>
                        <td style="text-align: right;">$${total.toLocaleString()}</td>
                    `;
                    table.appendChild(row);
                });

                document.getElementById('val-subtotal').textContent = `$${subtotal.toLocaleString()}`;
                document.getElementById('val-total').textContent = `$${subtotal.toLocaleString()}`;

                // Fetch Company Info (User profile or Config)
                // Using generic for now or local storage if available
                const userStr = localStorage.getItem('erpod_user');
                if (userStr) {
                    const user = JSON.parse(userStr);
                    // document.getElementById('company-name').textContent = user.empresa_nombre || 'Mi Empresa'; 
                }

            } catch (e) {
                console.error(e);
                alert('Error cargando datos');
            }
        }

        if (token) loadData();
        else {
            // Try to get parent token
            const pToken = window.opener?.localStorage.getItem('token');
            if (pToken) {
                localStorage.setItem('token', pToken);
                window.location.reload();
            } else {
                document.body.innerHTML = '<h1>No autorizado</h1>';
            }
        }
    </script>
</body>

</html>